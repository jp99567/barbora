
cmake_minimum_required(VERSION 3.5)
project (Bytd)

if( DEFINED ENV{BYTD_STAGING} )
 set(STAGING_DIR $ENV{BYTD_STAGING})
else()
 set(STAGING_DIR ../../staging)
endif()

set(THREADS_PREFER_PTHREAD_FLAG ON)
find_package(Threads REQUIRED)
find_package(Boost COMPONENTS system REQUIRED)
add_definitions(-DUSE_STD_THREAD)

IF(CMAKE_CROSSCOMPILING)
 set(Thrift_INCLUDE_DIRS ${STAGING_DIR}/bbb/usr/include)
 set(Thrift_LIBRARY_DIRS ${STAGING_DIR}/bbb/usr/local/lib)
 include_directories(${CMAKE_SYSROOT}/usr/local/pgsql/include ${Boost_INCLUDE_DIRS} ../owtherm ${Thrift_INCLUDE_DIRS} ${GPIOD_INCLUDE_DIRS})
 link_directories(${CMAKE_SYSROOT}/usr/local/pgsql/lib ${Thrift_LIBRARY_DIRS} ${Boost_LIBRARY_DIRS} ${STAGING_DIR}/bbb/usr/local/lib)
ELSE()
 include(FindPkgConfig)
 pkg_check_modules(SYSTEMDDAEMON REQUIRED libsystemd)
 pkg_check_modules(GPIOD REQUIRED libgpiod)
 include_directories(${Boost_INCLUDE_DIRS} ../owtherm ${Thrift_INCLUDE_DIRS} ${GPIOD_INCLUDE_DIRS} ../../../spdlog/include /usr/include/postgresql)
 link_directories(${CMAKE_SYSROOT}/usr/local/pgsql/lib ${Thrift_LIBRARY_DIRS} ${Boost_LIBRARY_DIRS} ${GPIOD_LIBRARY_DIRS})
ENDIF()

file(GLOB_RECURSE SRC_FILES FOLLOW_SYMLINKS *.cpp)
add_executable (bytd ${SRC_FILES})
target_link_libraries(bytd ${Boost_SYSTEM_LIBRARY} Threads::Threads thrift pq systemd gpiodcxx)
set(CMAKE_CXX_FLAGS "-Wall -Wno-psabi")
set(CMAKE_CXX_FLAGS_DEBUG "-g3")
set(CMAKE_CXX_FLAGS_RELEASE "-O2 -flto")
set_property(TARGET bytd PROPERTY CXX_STANDARD 14)

